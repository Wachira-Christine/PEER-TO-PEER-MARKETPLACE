//profile
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Services - StudentHub</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/profile.css">
</head>
<body>
    <div class="app-container">
        <nav class="top-nav">
            <div class="nav-brand">
                <span class="logo-icon">üéí</span>
                <span>StudentHub</span>
            </div>
            <div class="nav-actions">
                <button class="nav-btn secondary" onclick="window.location.href='home.html'">‚Üê Back</button>
                <button class="nav-btn primary" onclick="logout()">Logout</button>
            </div>
        </nav>

        <div class="container">
            <div style="max-width: 1000px; margin: 0 auto; background: var(--white); padding: 40px; border-radius: 20px; box-shadow: var(--shadow);">
                <h2 style="margin-bottom: 30px; font-size: 28px; font-weight: 800;">My Services</h2>

                <div class="tabs">
                    <button class="tab" data-tab="posted">üì¶ Posted</button>
                    <button class="tab" data-tab="requested">üõí Requested</button>
                    <button class="tab" data-tab="requests">üîî Requests</button>
                    <button class="tab" data-tab="create">‚ûï Post</button>
                </div>

                <!-- Posted Services Tab -->
                <div id="posted-tab" class="tab-content">
                    <div id="posted-content">
                        <!-- Posted services will be loaded here -->
                    </div>
                </div>

                <!-- Requested Services Tab -->
                <div id="requested-tab" class="tab-content">
                    <div class="filter-buttons">
                        <button class="nav-btn active" data-filter="all">All</button>
                        <button class="nav-btn" data-filter="pending">Pending</button>
                        <button class="nav-btn" data-filter="completed">Completed</button>
                    </div>
                    <div id="requested-content">
                        <!-- Requested services will be loaded here -->
                    </div>
                </div>

                <!-- Service Requests Tab -->
                <div id="requests-tab" class="tab-content">
                    <div id="requests-content">
                        <!-- Service requests will be loaded here -->
                    </div>
                </div>

                <!-- Create Service Tab -->
                <div id="create-tab" class="tab-content">
                    <form id="create-service-form">
                        <div class="form-group">
                            <label>Service Title</label>
                            <input type="text" id="serviceTitle" placeholder="e.g., Math Tutoring" required>
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <textarea id="serviceDescription" rows="4" placeholder="Describe your service..." required></textarea>
                        </div>
                        <div class="form-group">
                            <label>Price (KSh)</label>
                            <input type="number" id="servicePrice" min="0" placeholder="1500" required>
                        </div>
                        <div class="form-group">
                            <label>Category</label>
                            <select id="serviceCategory" required>
                                <option value="">Select</option>
                                <option value="Tutoring">Tutoring</option>
                                <option value="Design">Design</option>
                                <option value="Tech">Tech</option>
                                <option value="Writing">Writing</option>
                                <option value="Notes">Notes</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <button type="submit" class="btn-primary">Post Service</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="js/utils.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/services.js"></script>
    <script>
        let activeTab = 'posted';
        let requestedFilter = 'all';

        async function initProfile() {
            // Check authentication
            if (!await requireAuth()) return;

            // Check URL parameters for tab
            const urlParams = new URLSearchParams(window.location.search);
            const tabParam = urlParams.get('tab');
            if (tabParam && ['posted', 'requested', 'requests', 'create'].includes(tabParam)) {
                activeTab = tabParam;
            }

            // Load initial data
            await loadAllData();
            setupEventListeners();
            showTab(activeTab);
        }

        async function loadAllData() {
            await Promise.all([
                loadMyServices(),
                loadRequestedServices(),
                loadServiceRequests()
            ]);
        }

        function setupEventListeners() {
            // Tab switching
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    showTab(tab.dataset.tab);
                });
            });

            // Filter buttons for requested services
            document.querySelectorAll('[data-filter]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('[data-filter]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    requestedFilter = btn.dataset.filter;
                    renderRequestedServices();
                });
            });

            // Create service form
            document.getElementById('create-service-form').addEventListener('submit', async function(e) {
                e.preventDefault();

                const title = document.getElementById('serviceTitle').value;
                const description = document.getElementById('serviceDescription').value;
                const price = parseFloat(document.getElementById('servicePrice').value);
                const category = document.getElementById('serviceCategory').value;

                const success = await createService(title, description, price, category);
                if (success) {
                    this.reset();
                    await loadAllData();
                    showTab('posted');
                }
            });
        }

        function showTab(tabName) {
            // Update active tab
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.tab === tabName);
            });

            // Show active content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.style.display = 'none';
            });
            document.getElementById(`${tabName}-tab`).style.display = 'block';

            // Render content for the tab
            switch(tabName) {
                case 'posted':
                    renderPostedServices();
                    break;
                case 'requested':
                    renderRequestedServices();
                    break;
                case 'requests':
                    renderServiceRequests();
                    break;
            }

            activeTab = tabName;
        }

        function renderPostedServices() {
            const container = document.getElementById('posted-content');

            if (state.myServices.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì¶</div>
                        <h3>No services posted</h3>
                        <p>Start by posting your first service!</p>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="services-grid">
                        ${state.myServices.map(service => `
                            <div class="service-card">
                                <div class="service-header">
                                    <span class="service-icon">‚ö°</span>
                                    <span class="service-category">${service.category}</span>
                                </div>
                                <div class="service-body">
                                    <h3 class="service-title">${service.title}</h3>
                                    <p class="service-description">${service.description.substring(0, 100)}...</p>
                                    <div class="service-footer">
                                        <div class="service-price">KSh${service.price}</div>
                                        <button class="btn-contact" style="background: #ef4444;" onclick="deleteServiceHandler(${service.id})">Delete</button>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
        }

        function renderRequestedServices() {
            const container = document.getElementById('requested-content');
            let filteredServices = state.requestedServices;

            if (requestedFilter !== 'all') {
                filteredServices = state.requestedServices.filter(service => service.status === requestedFilter);
            }

            if (filteredServices.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üõí</div>
                        <h3>No ${requestedFilter === 'all' ? '' : requestedFilter} services</h3>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="services-grid">
                        ${filteredServices.map(service => `
                            <div class="service-card">
                                <div class="service-header">
                                    <span class="service-icon">‚ö°</span>
                                    <span class="service-category">${service.category}</span>
                                </div>
                                <div class="service-body">
                                    <h3 class="service-title">${service.title}</h3>
                                    <p class="service-description">${service.description.substring(0, 100)}...</p>
                                    <div style="padding: 12px; background: ${service.status === 'pending' ? '#fef3c7' : '#d1fae5'}; border-radius: 8px; margin: 12px 0; font-weight: 600;">
                                        Status: ${service.status.toUpperCase()}
                                    </div>
                                    <div class="service-footer">
                                        <div class="service-price">KSh${service.price}</div>
                                        ${service.status === 'completed' ? `
                                            <button class="btn-contact" onclick="showRatingModal(${service.service_id})">Rate</button>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
        }

        function renderServiceRequests() {
            const container = document.getElementById('requests-content');

            if (state.serviceRequests.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üîî</div>
                        <h3>No service requests</h3>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="services-grid">
                        ${state.serviceRequests.map(req => `
                            <div class="service-card">
                                <div class="service-header">
                                    <span class="service-icon">‚ö°</span>
                                    <span class="service-category">${req.category}</span>
                                </div>
                                <div class="service-body">
                                    <h3 class="service-title">${req.title}</h3>
                                    <p class="service-seller">By: ${req.buyer_name}</p>
                                    <div style="padding: 12px; background: #fef3c7; border-radius: 8px; margin: 12px 0; font-weight: 600;">
                                        Status: ${req.status.toUpperCase()}
                                    </div>
                                    <div class="service-footer">
                                        <div class="service-price">KSh${req.price}</div>
                                        <div style="display: flex; gap: 8px;">
                                            <button class="btn-contact" onclick="startChat(${req.buyer_id})">Message</button>
                                            ${req.status === 'pending' ? `
                                                <button class="btn-request" onclick="markCompleteHandler(${req.id})">Mark Complete</button>
                                            ` : `
                                                <span style="padding: 8px 16px; background: var(--accent); color: white; border-radius: 8px; font-weight: 600;">
                                                    Completed
                                                </span>
                                            `}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
        }

        async function deleteServiceHandler(serviceId) {
            const success = await deleteService(serviceId);
            if (success) {
                await loadAllData();
                renderPostedServices();
            }
        }

        async function markCompleteHandler(requestId) {
            const success = await markServiceComplete(requestId);
            if (success) {
                await loadAllData();
                renderServiceRequests();
            }
        }

        function startChat(userId) {
            window.location.href = `messages.html?user=${userId}`;
        }

        // Initialize profile page when page loads
        document.addEventListener('DOMContentLoaded', initProfile);
    </script>
</body>
</html>
